{% extends "base.html" %}

{% block title %}Upload PDF - Trivia Game{% endblock %}

{% block content %}
<div class="container">
  <h1 class="text-outline">ðŸ“„ Upload a PDF to Generate Trivia</h1>
  <p class="text-outline">Let GPT turn your document into fun!</p>

  {% if username %}
  <form id="upload-form">
    <input type="file" name="file" accept="application/pdf" required/>
    <button type="submit">Create a Trivia Game</button>
  </form>

  <p id="status-msg" style="margin-top: 1rem; font-weight: bold;"></p>
  <div id="spinner" style="display: none; margin-top: 1rem;">
    <div class="loader"></div>
  </div>

  <style>
    .loader {
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top: 4px solid #4ade80;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 0.8s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <script>
  document.getElementById("upload-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const statusMsg = document.getElementById("status-msg");
    const spinner = document.getElementById("spinner");
    const submitBtn = form.querySelector("button");

    submitBtn.disabled = true;
    statusMsg.innerText = "â³ Generating your trivia game...";
    spinner.style.display = "block";

    const xhr = new XMLHttpRequest();
    xhr.onload = async () => {
      setTimeout(() => {
        if (xhr.status === 200 && xhr.getResponseHeader("content-type").includes("text/html")) {
          document.open();
          document.write(xhr.responseText);
          document.close();
        } else {
          try {
            const error = JSON.parse(xhr.responseText);
            alert(error.detail || "Upload failed.");
          } catch {
            alert("Upload failed.");
          }
          statusMsg.innerText = "";
          spinner.style.display = "none";
          submitBtn.disabled = false;
        }
      }, 300);
    };

    xhr.onerror = () => {
      alert("Something went wrong.");
      statusMsg.innerText = "";
      spinner.style.display = "none";
      submitBtn.disabled = false;
    };

    xhr.open("POST", "/upload-pdf", true);
    xhr.withCredentials = true;
    xhr.send(formData);
  });
  </script>

  {% else %}
  <div class="fade-in"
       style="margin-top: 2rem; background: rgba(0, 0, 0, 0.6); padding: 1.5rem; max-width: 600px; margin-left: auto; margin-right: auto; border-radius: 10px;">
    <p style="font-size: 1.2rem; color: #ffeb3b; margin: 0;">
      ðŸ”’ You must be logged in to upload a file and generate trivia.
    </p>
    <p style="margin-top: 0.5rem;">
      <a href="/login" style="color: #4ade80; text-decoration: underline;">Log in here</a>
    </p>
  </div>
  {% endif %}
</div>
{% endblock %}
